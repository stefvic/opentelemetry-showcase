## How to
Install Loki stack
```shell
cd deploy
kubectl create ns loki
helm repo add grafana https://grafana.github.io/helm-charts
helm repo add prometheus https://prometheus-community.github.io/helm-charts
helm repo add elastic https://helm.elastic.co
helm repo update
helm  dependency update loki-stack
helm package loki-stack
helm upgrade --install loki loki-stack/loki-stack-2.4.0.tgz --namespace loki -f loki-stack-overwrite.yaml

# expose
kubectl apply -n loki -f loki-grafana-mapping.yaml # use ambassador
or 
kubectl apply -n loki -f tempo-jaeger-ui-ingress.yaml # use nginx ingress

```
Get Grafana password
```shell
kubectl get secret --namespace loki loki-grafana -o jsonpath="{.data.admin-password}" | base64 --decode ; echo
```
Install Tempo
```shell
helm upgrade --install tempo grafana/tempo-distributed --namespace loki -f tempo-distributed-overwrite.yaml
kubectl edit deployments.apps -n loki tempo-tempo-distributed-query-frontend
#   from         - --query.base-path=/
#   to           - --query.base-path=/jaeger

# expose
kubectl apply -n loki -f temp-jaeger-ui-mapping.yaml # use ambassador
or 
kubectl apply -n loki -f tempo-jaeger-ui-ingress.yaml # use nginx ingress
```

## Build
```shell
./gradlew clean build
```

## Install helm chart
```shell
kubectl create namespace opentelemetry-showcase
kubectl create namespace cassandra
helm repo add bitnami https://charts.bitnami.com/bitnami
helm install cassandra  bitnami/cassandra -n cassandra --set persistence.enabled=false
kubectl create namespace rabbitmq
helm install rabbitmq bitnami/rabbitmq -n rabbitmq --set persistence.enabled=false

helm upgrade -i opentelemetry-showcase hub/opentelemetry-showcase -n opentelemetry-showcase --version "1.0.0"
```

## Create secrets
```shell
export CASSANDRA_PASSWORD=$(kubectl get secret --namespace "cassandra" cassandra -o jsonpath="{.data.cassandra-password}" | base64 --decode)
kubectl create secret generic -n opentelemetry-showcase cassandra --from-literal=username=cassandra --from-literal=password="$CASSANDRA_PASSWORD"

export RABBITMQ_PASSWORD=$(kubectl get secret --namespace rabbitmq rabbitmq -o jsonpath="{.data.rabbitmq-password}" | base64 --decode)
kubectl create secret generic -n opentelemetry-showcase rabbitmq --from-literal=username=user --from-literal=password="$RABBITMQ_PASSWORD"
```

## Install k8s auto tracing admission controller webhook
[autotracing-admission-controller-webhook](autotracing-admission-controller-webhook)


## Cassandra info
```shell
Cassandra can be accessed through the following URLs from within the cluster:

  - CQL: cassandra.cassandra.svc.cluster.local:9042
  - Thrift: cassandra.cassandra.svc.cluster.local:9160

To get your password run:

   export CASSANDRA_PASSWORD=$(kubectl get secret --namespace "cassandra" cassandra -o jsonpath="{.data.cassandra-password}" | base64 --decode)

Check the cluster status by running:

   kubectl exec -it --namespace cassandra $(kubectl get pods --namespace cassandra -l app=cassandra,release=cassandra -o jsonpath='{.items[0].metadata.name}') nodetool status

To connect to your Cassandra cluster using CQL:

1. Run a Cassandra pod that you can use as a client:

   kubectl run --namespace cassandra cassandra-client --rm --tty -i --restart='Never' \
   --env CASSANDRA_PASSWORD=$CASSANDRA_PASSWORD \
   --image docker.io/bitnami/cassandra:3.11.10-debian-10-r78 -- bash

2. Connect using the cqlsh client:

   cqlsh -u cassandra -p $CASSANDRA_PASSWORD cassandra

To connect to your database from outside the cluster execute the following commands:

   kubectl port-forward --namespace cassandra svc/cassandra 9042:9042 &
   cqlsh -u cassandra -p $CASSANDRA_PASSWORD 127.0.0.1 9042
```

```shell
CREATE KEYSPACE IF NOT EXISTS opentelemetry WITH REPLICATION = { 'class' : 'SimpleStrategy', 'replication_factor' : 3 };
```

## Rabbit MQ info
```shell
Credentials:
    echo "Username      : user"
    echo "Password      : $(kubectl get secret --namespace rabbitmq rabbitmq -o jsonpath="{.data.rabbitmq-password}" | base64 --decode)"
    echo "ErLang Cookie : $(kubectl get secret --namespace rabbitmq rabbitmq -o jsonpath="{.data.rabbitmq-erlang-cookie}" | base64 --decode)"

Note that the credentials are saved in persistent volume claims and will not be changed upon upgrade or reinstallation unless the persistent volume claim has been deleted. If this is not the first installation of this chart, the credentials may not be valid.
This is applicable when no passwords are set and therefore the random password is autogenerated. In case of using a fixed password, you should specify it when upgrading.
More information about the credentials may be found at https://docs.bitnami.com/general/how-to/troubleshoot-helm-chart-issues/#credential-errors-while-upgrading-chart-releases.

RabbitMQ can be accessed within the cluster on port  at rabbitmq.rabbitmq.svc.

To access for outside the cluster, perform the following steps:

To Access the RabbitMQ AMQP port:

    echo "URL : amqp://127.0.0.1:5672/"
    kubectl port-forward --namespace rabbitmq svc/rabbitmq 5672:5672

To Access the RabbitMQ Management interface:

    echo "URL : http://127.0.0.1:15672/"
    kubectl port-forward --namespace rabbitmq svc/rabbitmq 15672:15672
```

